<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>8-Bit Synthesizer</title>
  <style>
    :root {
      /* Scripture Project Color Palette */
      --color-bg-primary: #23211a;
      --color-bg-secondary: #2d2b22;
      --color-bg-tertiary: #1a1812;
      --color-border-primary: #39362a;
      --color-border-secondary: #44412f;
      --color-border-dark: #18170f;
      --color-text-primary: #e8e5d2;
      --color-text-secondary: rgba(232, 229, 210, 0.8);
      --color-text-muted: rgba(232, 229, 210, 0.6);
      --color-accent-gold: #b6a432;
      --color-accent-beaver: #8b4513;
      --color-urgent: #7b3b3b;
      --color-urgent-border: #a04848;
      --color-easy: #2d6b3b;
      --color-easy-border: #3a8a4a;
      --color-focus: #6c6747;
      --color-focus-border: #8a8560;
      --color-chill: #3b4a6b;
      --color-chill-border: #4a5a7b;
      --color-waiting: #6b3b5c;
      --color-waiting-border: #8a4a75;
      --spacing-xs: 4px;
      --spacing-sm: 6px;
      --spacing-md: 8px;
      --spacing-lg: 12px;
      --spacing-xl: 16px;
      --spacing-2xl: 24px;
      --border-radius-sm: 0px;
      --border-radius-md: 0px;
      --border-radius-lg: 0px;
      --border-width-thin: 1px;
      --border-width-normal: 4px;
      --border-width-thick: 8px;
      --font-size-xs: 8px;
      --font-size-sm: 14px;
      --font-size-md: 16px;
      --font-size-lg: 20px;
      --font-size-xl: 24px;
      --shadow-inset: inset 4px 4px var(--color-border-secondary), inset -4px -4px var(--color-border-dark);
      --shadow-button: 2px 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-active: 0 0 0 3px var(--color-accent-gold), 3px 3px 6px rgba(0, 0, 0, 0.4);
      --transition-fast: 0.15s ease;
      --transition-normal: 0.2s ease;
      --transition-slow: 0.3s ease;
    }

    * {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-touch-action: manipulation;
    }

    body {
      background-color: var(--color-bg-primary);
      font-family: 'Press Start 2P', monospace;
      color: var(--color-text-primary);
      margin: 0;
      padding: var(--spacing-md);
      overflow-x: auto;
      min-height: 100vh;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background-color: var(--color-bg-secondary);
      border: var(--border-width-normal) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      padding: var(--spacing-md);
      overflow: visible;
      position: relative;
      box-shadow: var(--shadow-button);
    }

    h1 {
      font-size: var(--font-size-lg);
      text-align: center;
      color: var(--color-accent-gold);
      margin-bottom: var(--spacing-2xl);
      font-weight: normal;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }

    .section {
      margin-bottom: var(--spacing-lg);
      overflow: visible;
    }

    label {
      display: block;
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      margin-bottom: var(--spacing-sm);
      font-weight: normal;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      background: var(--color-bg-tertiary);
      border: var(--border-width-thin) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      padding: var(--spacing-xs) var(--spacing-md);
      flex-wrap: wrap;
    }

    input[type="range"] {
      flex-grow: 1;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    button {
      background-color: var(--color-bg-secondary);
      color: var(--color-accent-gold);
      border: var(--border-width-thin) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: var(--font-size-xs);
      font-family: 'Press Start 2P', monospace;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      transition: all var(--transition-normal);
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
      box-shadow: var(--shadow-button);
    }

    button:hover {
      border-color: var(--color-accent-gold);
      transform: translateY(-1px);
      box-shadow: var(--shadow-active);
    }

    button:active {
      transform: translateY(0);
    }

    select {
      width: 100%;
      background: var(--color-bg-tertiary);
      border: var(--border-width-thin) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      color: var(--color-accent-gold);
      font-size: var(--font-size-xs);
      font-family: 'Press Start 2P', monospace;
      padding: var(--spacing-xs);
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }
    .keyboard {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      justify-content: center;
      width: 100%;
      max-width: 100%;
      margin: 0 0 var(--spacing-md) 0;
      padding: 0;
      overflow: visible;
    }
    .key {
      flex: 1;
      min-width: 28px;
      height: 80px;
      background-color: var(--color-text-primary);
      border: var(--border-width-thin) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      color: var(--color-bg-primary);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      font-size: var(--font-size-xs);
      font-family: 'Press Start 2P', monospace;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      transition: all var(--transition-normal);
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }
    .key.black {
      background-color: var(--color-bg-tertiary);
      height: 50px;
      z-index: 1;
      margin: 0 -18px;
      color: var(--color-text-primary);
      flex: 0.6;
      min-width: 20px;
    }
    .key.active {
      background-color: var(--color-accent-gold) !important;
      color: var(--color-bg-primary);
    }
    
    .number-keys {
      display: flex;
      gap: 4px;
      justify-content: center;
      margin-bottom: 16px;
    }
    
    .num-key {
      width: 32px;
      height: 32px;
      background-color: #2a2a2a;
      border: 1px solid #555;
      color: #ffe066;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s;
    }
    
    .num-key:hover {
      background-color: #3a3a3a;
    }
    
    .num-key.active {
      background-color: #ffe066;
      color: #000;
    }
    
    .chord-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .chord-buttons {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .chord-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: var(--font-size-xs);
      font-family: 'Press Start 2P', monospace;
      border: var(--border-width-thin) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: all var(--transition-normal);
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }
    
    .chord-btn.major {
      background-color: var(--color-easy);
      color: var(--color-text-primary);
    }
    
    .chord-btn.minor {
      background-color: var(--color-waiting);
      color: var(--color-text-primary);
    }
    
    .chord-btn.diminished {
      background-color: var(--color-urgent);
      color: var(--color-text-primary);
    }
    
    .chord-btn:hover {
      filter: brightness(1.2);
      transform: translateY(-1px);
      box-shadow: var(--shadow-active);
    }
    
    .chord-presets {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .preset-btn {
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: var(--font-size-xs);
      font-family: 'Press Start 2P', monospace;
      background-color: var(--color-bg-secondary);
      color: var(--color-accent-gold);
      border: var(--border-width-thin) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: all var(--transition-normal);
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }
    
    .preset-btn:hover {
      background-color: var(--color-bg-tertiary);
      border-color: var(--color-accent-gold);
      transform: translateY(-1px);
      box-shadow: var(--shadow-active);
    }
    
    .preset-buttons {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .mood-chords {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      align-items: center;
    }
    
    .mood-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      align-items: center;
      width: 100%;
    }
    
    .mood-label {
      font-size: var(--font-size-xs);
      color: var(--color-accent-gold);
      font-weight: normal;
      text-align: center;
      margin-bottom: var(--spacing-xs);
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }
    
    .mood-buttons {
      display: flex;
      gap: var(--spacing-xs);
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
    }
    
    .mood-btn {
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: var(--font-size-xs);
      font-family: 'Press Start 2P', monospace;
      border: var(--border-width-thin) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: all var(--transition-normal);
      color: var(--color-text-primary);
      font-weight: normal;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }
    
    .mood-btn.happy {
      background-color: var(--color-easy);
    }
    
    .mood-btn.sad {
      background-color: var(--color-waiting);
    }
    
    .mood-btn.tense {
      background-color: var(--color-urgent);
    }
    
    .mood-btn.dreamy {
      background-color: var(--color-chill);
    }
    
    .mood-btn:hover {
      filter: brightness(1.3);
      transform: translateY(-1px);
      box-shadow: var(--shadow-active);
    }
    
    .mood-btn:active {
      transform: translateY(0);
    }
    
    .collapsible {
      border: var(--border-width-thin) solid var(--color-border-primary);
      border-radius: var(--border-radius-sm);
      margin-bottom: var(--spacing-md);
      background-color: var(--color-bg-secondary);
      box-shadow: var(--shadow-button);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      background-color: var(--color-bg-secondary);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      transition: all var(--transition-normal);
    }
    
    .section-header:hover {
      background-color: var(--color-bg-tertiary);
    }
    
    .section-header label {
      margin: 0;
      font-size: var(--font-size-sm);
      color: var(--color-accent-gold);
      font-weight: normal;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: none;
      text-rendering: optimizeSpeed;
    }
    
    .collapse-icon {
      color: var(--color-accent-gold);
      font-size: var(--font-size-xs);
      transition: transform var(--transition-normal);
    }
    
    .collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .section-content {
      padding: var(--spacing-lg);
      background-color: var(--color-bg-tertiary);
      transition: all var(--transition-slow);
      overflow: hidden;
    }
    
    .collapsed .section-content {
      display: none;
    }
    
    /* Custom Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1c1b1b;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #4a4a4a;
      border-radius: 4px;
      border: 1px solid #3e3e3e;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #5a5a5a;
    }
    
    ::-webkit-scrollbar-corner {
      background: #1c1b1b;
    }
    
    /* Firefox Scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: #4a4a4a #1c1b1b;
    }
    
    /* Custom Slider Styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }
    
    input[type="range"]::-webkit-slider-track {
      width: 100%;
      height: 8px;
      background: var(--color-bg-primary);
      border: 2px solid var(--color-border-primary);
      border-radius: 0px;
      box-shadow: inset 2px 2px var(--color-border-secondary), inset -2px -2px var(--color-border-dark);
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 0px;
      background: var(--color-accent-gold);
      border: 2px solid var(--color-border-primary);
      cursor: pointer;
      box-shadow: var(--shadow-button);
      transition: all var(--transition-normal);
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      background: var(--color-text-primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-active);
    }
    
    input[type="range"]::-webkit-slider-thumb:active {
      background: var(--color-text-primary);
      transform: translateY(0);
    }
    
    /* Firefox Slider */
    input[type="range"]::-moz-range-track {
      width: 100%;
      height: 8px;
      background: var(--color-bg-primary);
      border: 2px solid var(--color-border-primary);
      border-radius: 0px;
      box-shadow: inset 2px 2px var(--color-border-secondary), inset -2px -2px var(--color-border-dark);
    }
    
    input[type="range"]::-moz-range-thumb {
      height: 16px;
      width: 16px;
      border-radius: 0px;
      background: var(--color-accent-gold);
      border: 2px solid var(--color-border-primary);
      cursor: pointer;
      box-shadow: var(--shadow-button);
      transition: all var(--transition-normal);
    }
    
    input[type="range"]::-moz-range-thumb:hover {
      background: var(--color-text-primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-active);
    }
    
    input[type="range"]::-moz-range-thumb:active {
      background: var(--color-text-primary);
      transform: translateY(0);
    }
    
    .value-display {
      font-size: 10px;
      color: #ffe066;
      font-weight: bold;
      min-width: 40px;
      text-align: center;
      padding: 2px 6px;
      background: #2a2a2a;
      border: 1px solid #555;
      border-radius: 3px;
    }
    
    .reset-btn {
      background-color: #7c4a4a;
      color: #fff;
      border: 1px solid #555;
      padding: 2px 6px;
      font-size: 9px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
    }
    
    .reset-btn:hover {
      background-color: #8c5a5a;
      transform: scale(1.05);
    }
    
    .reset-btn:active {
      transform: scale(0.95);
    }
    
    .sustain-btn {
      background-color: #4a7c59;
      color: #fff;
      border: 1px solid #555;
      padding: 2px 6px;
      font-size: 9px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
    }
    
    .sustain-btn.active {
      background-color: #ffe066;
      color: #000;
    }
    
    .sustain-btn:hover {
      filter: brightness(1.2);
      transform: scale(1.05);
    }
    
    .sustain-btn:active {
      transform: scale(0.95);
    }
    
    .circle-of-fifths {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 300px;
      width: 300px;
      position: relative;
      margin: 0 auto 40px auto;
      margin-left: 25px;
      overflow: visible;
    }
    
    .circle-key {
      position: absolute;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid #555;
      background-color: #2a2a2a;
      color: #ffe066;
      z-index: 10;
    }
    
    .circle-key.major {
      background-color: #4a7c59;
      color: #fff;
    }
    
    .circle-key.minor {
      background-color: #7c4a7c;
      color: #fff;
    }
    
    .circle-key.dominant {
      background-color: #7c6b4a;
      color: #fff;
    }
    
    .circle-key.diminished {
      background-color: #7c4a4a;
      color: #fff;
    }
    
    .circle-key:hover {
      transform: scale(1.1);
      filter: brightness(1.2);
      border-color: #ffe066;
    }
    
    .circle-key:active {
      transform: scale(0.95);
    }
    
    .circle-key:hover {
      transform: scale(1.1);
      filter: brightness(1.2);
    }
    
    .waveform-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .waveform-btn {
      padding: 12px 16px;
      font-size: 11px;
      background-color: #2a2a2a;
      color: #ffe066;
      border: 2px solid #555;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 80px;
      text-transform: uppercase;
      font-weight: bold;
    }
    
    .waveform-btn:hover {
      background-color: #3a3a3a;
      border-color: #ffe066;
    }
    
    .waveform-btn.active {
      background-color: #ffe066;
      color: #000;
      border-color: #ffe066;
    }
    
    .timeline-container {
      background: #151515;
      border: 1px solid #3e3e3e;
      padding: 8px;
    }
    
    .timeline-header {
      margin-bottom: 8px;
    }
    
    .step-indicators {
      display: flex;
      gap: 2px;
      margin-bottom: 8px;
      margin-left: 68px;
      align-items: flex-start;
    }
    
    .step-indicator {
      width: 24px;
      height: 24px;
      background: #2a2a2a;
      border: 1px solid #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: #ccc;
      box-sizing: border-box;
    }
    
    .step-indicator.active {
      background: #ffe066;
      color: #000;
    }
    
    .timeline-tracks {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .track {
      display: flex;
      gap: 2px;
      align-items: center;
    }
    
    .track-label {
      width: 60px;
      font-size: 11px;
      color: #ffe066;
      text-align: right;
      padding-right: 8px;
    }
    
    .track-steps {
      display: flex;
      gap: 2px;
    }
    
    .step {
      width: 24px;
      height: 24px;
      background: #2a2a2a;
      border: 1px solid #555;
      cursor: pointer;
      transition: all 0.1s;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      box-sizing: border-box;
    }
    
    .step:hover {
      background: #3a3a3a;
    }
    
    .step.active {
      background: #ffe066;
      border-color: #ffe066;
    }
    
    .step.playing {
      background: #ff6b6b;
      border-color: #ff6b6b;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>8-BIT SYNTHESIZER</h1>
    
    

    <div class="section collapsible collapsed">
      <div class="section-header" onclick="toggleSection('circle')">
        <label>🎯 Circle of Fifths</label>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="section-content" id="circle-content">
        <div class="circle-of-fifths" id="circleOfFifths"></div>
      </div>
    </div>

    <div class="section collapsible collapsed">
      <div class="section-header" onclick="toggleSection('mood-chords')">
        <label>😊 Mood Chords</label>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="section-content" id="mood-chords-content">
        <div class="mood-chords">
          <div class="mood-group">
            <div class="mood-label">😊 Happy</div>
            <div class="mood-buttons">
              <button onclick="playChord('Cmaj')" class="mood-btn happy">C</button>
              <button onclick="playChord('Fmaj')" class="mood-btn happy">F</button>
              <button onclick="playChord('Gmaj')" class="mood-btn happy">G</button>
              <button onclick="playChord('Cmaj7')" class="mood-btn happy">Cmaj7</button>
            </div>
          </div>
          <div class="mood-group">
            <div class="mood-label">😢 Sad</div>
            <div class="mood-buttons">
              <button onclick="playChord('Amin')" class="mood-btn sad">Am</button>
              <button onclick="playChord('Dmin')" class="mood-btn sad">Dm</button>
              <button onclick="playChord('Emin')" class="mood-btn sad">Em</button>
              <button onclick="playChord('Amin7')" class="mood-btn sad">Am7</button>
            </div>
          </div>
          <div class="mood-group">
            <div class="mood-label">😤 Tense</div>
            <div class="mood-buttons">
              <button onclick="playChord('G7')" class="mood-btn tense">G7</button>
              <button onclick="playChord('Bdim')" class="mood-btn tense">B°</button>
              <button onclick="playChord('Dmin7')" class="mood-btn tense">Dm7</button>
              <button onclick="playChord('Bm7b5')" class="mood-btn tense">Bm7b5</button>
            </div>
          </div>
          <div class="mood-group">
            <div class="mood-label">😌 Dreamy</div>
            <div class="mood-buttons">
              <button onclick="playChord('Fmaj7')" class="mood-btn dreamy">Fmaj7</button>
              <button onclick="playChord('Emin7')" class="mood-btn dreamy">Em7</button>
              <button onclick="playChord('Cmaj7')" class="mood-btn dreamy">Cmaj7</button>
              <button onclick="playChord('Amin7')" class="mood-btn dreamy">Am7</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section collapsible collapsed">
      <div class="section-header" onclick="toggleSection('plain-chords')">
        <label>🎼 Plain Chords</label>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="section-content" id="plain-chords-content">
        <div class="chord-buttons">
          <button onclick="playChord('Cmaj')" class="chord-btn major">C</button>
          <button onclick="playChord('Dmin')" class="chord-btn minor">Dm</button>
          <button onclick="playChord('Emin')" class="chord-btn minor">Em</button>
          <button onclick="playChord('Fmaj')" class="chord-btn major">F</button>
          <button onclick="playChord('Gmaj')" class="chord-btn major">G</button>
          <button onclick="playChord('Amin')" class="chord-btn minor">Am</button>
          <button onclick="playChord('Bdim')" class="chord-btn diminished">B°</button>
        </div>
      </div>
    </div>

    <div class="section keyboard" id="keyboard"></div>

    <div class="section collapsible collapsed">
      <div class="section-header" onclick="toggleSection('chords')">
        <label>🎼 Chord Progressions</label>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="section-content" id="chords-content">
        <div class="chord-controls">
          <div class="chord-presets">
            <button onclick="playProgression('I-IV-V')" class="preset-btn">I-IV-V</button>
            <button onclick="playProgression('ii-V-I')" class="preset-btn">ii-V-I</button>
            <button onclick="playProgression('I-V-vi-IV')" class="preset-btn">Pop</button>
            <button onclick="playProgression('vi-IV-I-V')" class="preset-btn">Sad</button>
            <button onclick="playProgression('Happy')" class="preset-btn">😊 Happy</button>
            <button onclick="playProgression('Tense')" class="preset-btn">😤 Tense</button>
            <button onclick="playProgression('Dreamy')" class="preset-btn">😌 Dreamy</button>
            <button onclick="playProgression('Jazz')" class="preset-btn">🎷 Jazz</button>
          </div>
        </div>
      </div>
    </div>

    <div class="section collapsible collapsed">
      <div class="section-header" onclick="toggleSection('presets')">
        <label>🎛️ Presets</label>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="section-content" id="presets-content">
        <div class="preset-buttons">
          <button onclick="loadPreset('piano')" class="preset-btn">Piano</button>
          <button onclick="loadPreset('bass')" class="preset-btn">Bass</button>
          <button onclick="loadPreset('lead')" class="preset-btn">Lead</button>
          <button onclick="loadPreset('pad')" class="preset-btn">Pad</button>
          <button onclick="loadPreset('pluck')" class="preset-btn">Pluck</button>
          <button onclick="loadPreset('bell')" class="preset-btn">Bell</button>
          <button onclick="loadPreset('chord')" class="preset-btn">Chord</button>
          <button onclick="loadPreset('arp')" class="preset-btn">Arp</button>
        </div>
      </div>
    </div>

    <div class="section collapsible collapsed">
      <div class="section-header" onclick="toggleSection('scrypture-sounds')">
        <label>🦫 Scrypture Sounds</label>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="section-content" id="scrypture-sounds-content">
        <div class="preset-buttons">
          <button onclick="loadPreset('achievement-common')" class="preset-btn">🏆 Common</button>
          <button onclick="loadPreset('achievement-rare')" class="preset-btn">💎 Rare</button>
          <button onclick="loadPreset('achievement-legendary')" class="preset-btn">👑 Legendary</button>
          <button onclick="loadPreset('task-complete')" class="preset-btn">✅ Complete</button>
          <button onclick="loadPreset('level-up')" class="preset-btn">🎉 Level Up</button>
          <button onclick="loadPreset('bobr-greeting')" class="preset-btn">🦫 Bóbr</button>
          <button onclick="loadPreset('dam-build')" class="preset-btn">🏗️ Dam Build</button>
          <button onclick="loadPreset('streak-milestone')" class="preset-btn">🔥 Streak</button>
          <button onclick="loadPreset('ui-click')" class="preset-btn">🖱️ UI Click</button>
          <button onclick="loadPreset('form-submit')" class="preset-btn">📝 Submit</button>
          <button onclick="loadPreset('modal-open')" class="preset-btn">📋 Modal</button>
          <button onclick="loadPreset('xp-gain')" class="preset-btn">⭐ XP Gain</button>
        </div>
      </div>
    </div>

    <div class="section collapsible collapsed">
      <div class="section-header" onclick="toggleSection('waveform')">
        <label>🎵 Waveform</label>
        <span class="collapse-icon">▼</span>
      </div>
      <div class="section-content" id="waveform-content">
        <div class="waveform-buttons">
          <button onclick="setWaveform('sine')" class="waveform-btn active" data-waveform="sine"> Sine</button>
          <button onclick="setWaveform('square')" class="waveform-btn" data-waveform="square"> Square</button>
          <button onclick="setWaveform('triangle')" class="waveform-btn" data-waveform="triangle"> Triangle</button>
          <button onclick="setWaveform('sawtooth')" class="waveform-btn" data-waveform="sawtooth"> Sawtooth</button>
        </div>
      </div>
    </div>

    <div class="section">
      <label>Volume</label>
      <div class="slider-group">
        <button onclick="adjust('volume', -5)">-</button>
        <input type="range" id="volume" min="0" max="100" value="20">
        <button onclick="adjust('volume', 5)">+</button>
        <span class="value-display" id="volumeValue">20%</span>
      </div>
    </div>

    <div class="section">
      <label>Attack</label>
      <div class="slider-group">
        <button onclick="adjust('attack', -1)">-</button>
        <input type="range" id="attack" min="0" max="100" value="1">
        <button onclick="adjust('attack', 1)">+</button>
      </div>
    </div>

    <div class="section">
      <label>Release</label>
      <div class="slider-group">
        <button onclick="adjust('release', -1)">-</button>
        <input type="range" id="release" min="0" max="100" value="10">
        <button onclick="adjust('release', 1)">+</button>
        <button onclick="toggleSustain()" id="sustainBtn" class="sustain-btn">Sustain</button>
      </div>
    </div>

    <div class="section">
      <label>Detune</label>
      <div class="slider-group">
        <button onclick="adjust('detune', -5)">-</button>
        <input type="range" id="detune" min="-100" max="100" value="0">
        <button onclick="adjust('detune', 5)">+</button>
        <button onclick="resetDetune()" class="reset-btn">Reset</button>
        <span class="value-display" id="detuneValue">0¢</span>
      </div>
    </div>

    <div class="section">
      <label>Reverb</label>
      <select id="reverb">
        <option value="off">Off</option>
        <option value="on">On</option>
      </select>
    </div>

    <div class="section">
      <label>Arpeggiator</label>
      <select id="arpeggiator">
        <option value="off">Off</option>
        <option value="up">Up</option>
        <option value="down">Down</option>
      </select>
    </div>

    <div class="section">
      <label>LFO Rate</label>
      <div class="slider-group">
        <button onclick="adjust('lfoRate', -0.1)">-</button>
        <input type="range" id="lfoRate" min="0" max="10" value="0" step="0.1">
        <button onclick="adjust('lfoRate', 0.1)">+</button>
        <span class="value-display" id="lfoRateValue">0 Hz</span>
      </div>
    </div>

    <div class="section">
      <label>LFO Depth</label>
      <div class="slider-group">
        <button onclick="adjust('lfoDepth', -1)">-</button>
        <input type="range" id="lfoDepth" min="0" max="50" value="5">
        <button onclick="adjust('lfoDepth', 1)">+</button>
      </div>
    </div>

    <div class="section">
      <label>LFO Target</label>
      <select id="lfoTarget">
        <option value="pitch">Pitch</option>
        <option value="volume">Volume</option>
        <option value="filter">Filter</option>
      </select>
    </div>
  </div>

  <div class="container" style="margin-top: 20px;">
    <h1>SEQUENCER</h1>
    
    <div class="section">
      <label>BPM</label>
      <div class="slider-group">
        <button onclick="adjust('bpm', -5)">-</button>
        <input type="range" id="bpm" min="60" max="200" value="120">
        <button onclick="adjust('bpm', 5)">+</button>
      </div>
    </div>

    <div class="section">
      <label>Steps</label>
      <div class="slider-group">
        <button onclick="adjust('steps', -1)">-</button>
        <input type="range" id="steps" min="4" max="16" value="8">
        <button onclick="adjust('steps', 1)">+</button>
      </div>
    </div>

    <div class="section">
      <div class="slider-group">
        <button onclick="playSequence()" id="playBtn">Play</button>
        <button onclick="stopSequence()" id="stopBtn">Stop</button>
        <button onclick="clearSequence()">Clear</button>
        <button onclick="toggleDrawMode()" id="drawBtn">Draw</button>
      </div>
    </div>

    <div class="section">
      <div class="timeline-container">
        <div class="timeline-header">
          <div class="step-indicators" id="stepIndicators"></div>
        </div>
        <div class="timeline-tracks" id="timelineTracks"></div>
      </div>
    </div>
  </div>

  <script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioContext.createGain();
    masterGain.connect(audioContext.destination);
    masterGain.gain.value = 0.2;

    const dryGain = audioContext.createGain();
    const wetGain = audioContext.createGain();
    const convolver = audioContext.createConvolver();
    dryGain.connect(masterGain);
    wetGain.connect(masterGain);
    convolver.connect(wetGain);

    convolver.buffer = (() => {
      const rate = audioContext.sampleRate;
      const length = rate * 2;
      const impulse = audioContext.createBuffer(2, length, rate);
      for (let i = 0; i < 2; i++) {
        const ch = impulse.getChannelData(i);
        for (let j = 0; j < length; j++) {
          ch[j] = (Math.random() * 2 - 1) * Math.pow(1 - j / length, 2);
        }
      }
      return impulse;
    })();

    let waveform = 'sine';
    let attack = 0.01;
    let release = 0.1;
    let detune = 0;
    let reverbEnabled = false;
    let lfoRate = 0;
    let lfoDepth = 5;
    let lfoTarget = 'pitch';
    let bpm = 120;
    let steps = 8;
    let isPlaying = false;
    let currentPattern = 0;
    let currentStep = 0;
    let sequenceInterval = null;
    let drawMode = false;
    let isDrawing = false;
    let isDraggingCircle = false;
    let sustainMode = false;
    const pressed = new Set();
    const numberKeyPatterns = {
      0: [], // Empty pattern
      1: [0, 4, 8, 12], // Basic beat
      2: [0, 2, 4, 6, 8, 10, 12, 14], // Double time
      3: [0, 3, 6, 9, 12, 15], // Triplet feel
      4: [0, 4, 8, 12, 1, 5, 9, 13], // Two-track pattern
      5: [0, 2, 4, 6, 8, 10, 12, 14, 1, 3, 5, 7, 9, 11, 13, 15], // Full pattern
      6: [0, 6, 12], // Sparse pattern
      7: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], // All steps
      8: [0, 8, 1, 9, 2, 10, 3, 11], // Alternating pattern
      9: [0, 3, 6, 9, 12, 15, 1, 4, 7, 10, 13] // Complex pattern
    };
    const activeNotes = {};
    const sequence = {
      C: new Array(32).fill(false),
      D: new Array(32).fill(false),
      E: new Array(32).fill(false),
      F: new Array(32).fill(false),
      G: new Array(32).fill(false),
      A: new Array(32).fill(false),
      B: new Array(32).fill(false)
    };
    const notes = [
      { freq: 261.63, key: 'a' },
      { freq: 277.18, key: 'w', black: true },
      { freq: 293.66, key: 's' },
      { freq: 311.13, key: 'e', black: true },
      { freq: 329.63, key: 'd' },
      { freq: 349.23, key: 'f' },
      { freq: 369.99, key: 't', black: true },
      { freq: 392.00, key: 'g' },
      { freq: 415.30, key: 'y', black: true },
      { freq: 440.00, key: 'h' },
      { freq: 466.16, key: 'u', black: true },
      { freq: 493.88, key: 'j' },
      { freq: 523.25, key: 'k' }
    ];

    const chords = {
      // C major scale chords
      Cmaj: [261.63, 329.63, 392.00],  // C E G
      Dmin: [293.66, 349.23, 440.00],  // D F A
      Emin: [329.63, 392.00, 493.88],  // E G B
      Fmaj: [349.23, 440.00, 523.25],  // F A C
      Gmaj: [392.00, 493.88, 587.33],  // G B D
      Amin: [440.00, 523.25, 659.25],  // A C E
      Bdim: [493.88, 587.33, 698.46],  // B D F
      
      // Extended chords
      Cmaj7: [261.63, 329.63, 392.00, 493.88],  // C E G B
      Dmin7: [293.66, 349.23, 440.00, 523.25],  // D F A C
      Emin7: [329.63, 392.00, 493.88, 587.33],  // E G B D
      Fmaj7: [349.23, 440.00, 523.25, 659.25],  // F A C E
      G7: [392.00, 493.88, 587.33, 698.46],     // G B D F
      Amin7: [440.00, 523.25, 659.25, 783.99],  // A C E G
      Bm7b5: [493.88, 587.33, 698.46, 783.99]   // B D F A
    };
    
    const chordProgressions = {
      // Classic Progressions
      'I-IV-V': ['Cmaj', 'Fmaj', 'Gmaj'],
      'ii-V-I': ['Dmin', 'Gmaj', 'Cmaj'],
      'I-V-vi-IV': ['Cmaj', 'Gmaj', 'Amin', 'Fmaj'],
      'vi-IV-I-V': ['Amin', 'Fmaj', 'Cmaj', 'Gmaj'],
      'I-vi-ii-V': ['Cmaj', 'Amin', 'Dmin', 'Gmaj'],
      'ii-vi-I-V': ['Dmin', 'Amin', 'Cmaj', 'Gmaj'],
      
      // Mood-Based Progressions
      'Happy': ['Cmaj', 'Fmaj', 'Gmaj', 'Cmaj'],
      'Sad': ['Amin', 'Dmin', 'Emin', 'Amin'],
      'Tense': ['G7', 'Bdim', 'Dmin7', 'G7'],
      'Dreamy': ['Fmaj7', 'Emin7', 'Cmaj7', 'Amin7'],
      'Jazz': ['Dmin7', 'G7', 'Cmaj7', 'Fmaj7'],
      'Blues': ['Cmaj', 'Fmaj', 'G7', 'Cmaj']
    };
    
    const circleOfFifths = [
      { key: 'C', type: 'major', angle: 0, chordType: 'major' },
      { key: 'G', type: 'dominant', angle: 30, chordType: 'dominant' },
      { key: 'D', type: 'major', angle: 60, chordType: 'major' },
      { key: 'A', type: 'major', angle: 90, chordType: 'major' },
      { key: 'E', type: 'major', angle: 120, chordType: 'major' },
      { key: 'B', type: 'diminished', angle: 150, chordType: 'diminished' },
      { key: 'F#', type: 'major', angle: 180, chordType: 'major' },
      { key: 'C#', type: 'major', angle: 210, chordType: 'major' },
      { key: 'G#', type: 'dominant', angle: 240, chordType: 'dominant' },
      { key: 'D#', type: 'major', angle: 270, chordType: 'major' },
      { key: 'A#', type: 'major', angle: 300, chordType: 'major' },
      { key: 'F', type: 'major', angle: 330, chordType: 'major' }
    ];

    function playChord(name) {
      if (!chords[name]) return;
      const validFreqs = chords[name].filter(freq => !isNaN(parseFloat(freq)) && parseFloat(freq) > 0);
      
      // Create a temporary gain node for chord volume control
      const chordGain = audioContext.createGain();
      chordGain.gain.value = 0.3; // Reduce volume to 30% for chords
      chordGain.connect(masterGain);
      
      // Highlight piano keys for chord notes
      const chordKeys = [];
      validFreqs.forEach(freq => {
        // Find key by frequency with tolerance for rounding differences
        const keyElements = document.querySelectorAll('.key');
        const targetFreq = parseFloat(freq);
        
        keyElements.forEach(keyElement => {
          const keyFreq = parseFloat(keyElement.dataset.freq);
          if (Math.abs(keyFreq - targetFreq) < 0.1) { // Small tolerance for rounding
            keyElement.classList.add('active');
            chordKeys.push(keyElement);
          }
        });
      });
      
      validFreqs.forEach(freq => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        // Create LFO
        const lfo = audioContext.createOscillator();
        const lfoGain = audioContext.createGain();
        lfo.frequency.value = lfoRate;
        lfoGain.gain.value = lfoDepth;
        lfo.connect(lfoGain);
        
        osc.type = waveform;
        osc.frequency.value = freq;
        osc.detune.value = detune;
        
        // Apply LFO based on target
        if (lfoTarget === 'pitch') {
          lfoGain.connect(osc.detune);
        } else if (lfoTarget === 'volume') {
          lfoGain.connect(gain.gain);
        } else if (lfoTarget === 'filter') {
          const filter = audioContext.createBiquadFilter();
          filter.type = 'lowpass';
          filter.frequency.value = 2000;
          filter.Q.value = 1;
          lfoGain.connect(filter.frequency);
          osc.connect(filter);
          filter.connect(gain);
        } else {
          osc.connect(gain);
        }
        
        if (lfoTarget !== 'filter') {
          osc.connect(gain);
        }
        
        gain.connect(chordGain);
        if (reverbEnabled) gain.connect(convolver);
        gain.gain.setValueAtTime(0, audioContext.currentTime);
        gain.gain.linearRampToValueAtTime(1, audioContext.currentTime + attack);
        
        osc.start();
        lfo.start();
        
        // Stop after 1.5 seconds with smooth fade out
        setTimeout(() => {
          gain.gain.cancelScheduledValues(audioContext.currentTime);
          gain.gain.setValueAtTime(gain.gain.value, audioContext.currentTime);
          // Use a longer, smoother fade out for chords
          const smoothRelease = Math.max(0.5, release * 2); // At least 0.5s fade
          gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + smoothRelease);
          osc.stop(audioContext.currentTime + smoothRelease);
          lfo.stop(audioContext.currentTime + smoothRelease);
        }, 1000);
      });
      
      // Remove highlights after chord finishes
      setTimeout(() => {
        chordKeys.forEach(keyElement => {
          keyElement.classList.remove('active');
        });
      }, 1500);
    }

    function playProgression(name) {
      if (!chordProgressions[name]) return;
      const progression = chordProgressions[name];
      let currentChord = 0;
      
      const playNextChord = () => {
        if (currentChord < progression.length) {
          playChord(progression[currentChord]);
          currentChord++;
          setTimeout(playNextChord, 1000);
        }
      };
      
      playNextChord();
    }

    function createCircleOfFifths() {
      const circleContainer = document.getElementById('circleOfFifths');
      const radius = 130;
      
      circleOfFifths.forEach((key, index) => {
        const angle = (key.angle * Math.PI) / 180;
        const x = Math.cos(angle) * radius + 150;
        const y = Math.sin(angle) * radius + 150;
        
        const keyElement = document.createElement('div');
        keyElement.className = `circle-key ${key.type}`;
        keyElement.textContent = key.key;
        keyElement.style.left = `${x}px`;
        keyElement.style.top = `${y}px`;
        
        function playCircleKey(key) {
          // Visual feedback
          keyElement.style.transform = 'scale(1)';
          setTimeout(() => {
            keyElement.style.transform = '';
          }, 100);
          
          // Play the appropriate chord based on type
          let chordName;
          if (key.chordType === 'dominant') {
            chordName = key.key + '7';
          } else if (key.chordType === 'diminished') {
            chordName = key.key + 'dim';
          } else {
            chordName = key.key + 'maj';
          }
          
          if (chords[chordName]) {
            playChord(chordName);
          } else {
            // Fallback to major chord
            const fallbackChord = key.key + 'maj';
            if (chords[fallbackChord]) {
              playChord(fallbackChord);
            } else {
              // Final fallback to C major
              playChord('Cmaj');
            }
          }
        }
        
        keyElement.addEventListener('mousedown', () => {
          isDraggingCircle = true;
          playCircleKey(key);
        });
        
        keyElement.addEventListener('mouseenter', () => {
          if (isDraggingCircle) {
            playCircleKey(key);
          }
        });
        
        keyElement.addEventListener('mousedown', () => {
          isDraggingCircle = true;
          // Removed playCircleKey call to prevent double sound
        });
        
        // Add mouse down/up for better interaction
        keyElement.addEventListener('mouseup', () => {
          keyElement.style.transform = '';
          // Remove any sound that might be playing on mouseup
        });
        
        keyElement.addEventListener('mouseleave', () => {
          keyElement.style.transform = '';
        });
        
        circleContainer.appendChild(keyElement);
      });
    }

    const keyboard = document.getElementById('keyboard');
    notes.forEach(note => {
      const el = document.createElement('div');
      el.className = 'key' + (note.black ? ' black' : '');
      el.textContent = note.key.toUpperCase();
      el.dataset.freq = note.freq;
      el.dataset.key = note.key;
      keyboard.appendChild(el);
    });

    function startNote(freq, el = null) {
      // Ensure frequency is a number
      const frequency = parseFloat(freq);
      if (isNaN(frequency) || frequency <= 0) return;
      
      // Allow multiple notes of the same frequency (polyphony)
      const noteId = frequency + '_' + Date.now() + '_' + Math.random();
      
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      
      // Create LFO
      const lfo = audioContext.createOscillator();
      const lfoGain = audioContext.createGain();
      lfo.frequency.value = lfoRate;
      lfoGain.gain.value = lfoDepth;
      lfo.connect(lfoGain);
      
      osc.type = waveform;
      osc.frequency.value = frequency;
      osc.detune.value = detune;
      
      // Apply LFO based on target
      if (lfoTarget === 'pitch') {
        lfoGain.connect(osc.detune);
      } else if (lfoTarget === 'volume') {
        lfoGain.connect(gain.gain);
      } else if (lfoTarget === 'filter') {
        const filter = audioContext.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 2000;
        filter.Q.value = 1;
        lfoGain.connect(filter.frequency);
        osc.connect(filter);
        filter.connect(gain);
      } else {
        osc.connect(gain);
      }
      
      if (lfoTarget !== 'filter') {
        osc.connect(gain);
      }
      
      gain.connect(dryGain);
      if (reverbEnabled) gain.connect(convolver);
      gain.gain.setValueAtTime(0, audioContext.currentTime);
      gain.gain.linearRampToValueAtTime(1, audioContext.currentTime + attack);
      
      osc.start();
      lfo.start();
      activeNotes[noteId] = { osc, gain, lfo, freq: frequency };
      if (el) el.classList.add('active');
    }

    function stopNote(freq, el = null) {
      // Ensure frequency is a number
      const frequency = parseFloat(freq);
      if (isNaN(frequency)) return;
      
      // Find all notes with this frequency
      const notesToStop = Object.entries(activeNotes).filter(([id, note]) => Math.abs(note.freq - frequency) < 0.1);
      
      notesToStop.forEach(([noteId, note]) => {
        const { osc, gain, lfo } = note;
        
        // Smooth fade out
        const currentGain = gain.gain.value;
        const fadeTime = Math.max(0.1, release); // Minimum 0.1s fade
        
        gain.gain.cancelScheduledValues(audioContext.currentTime);
        gain.gain.setValueAtTime(currentGain, audioContext.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + fadeTime);
        
        // Stop oscillator and LFO after fade
        osc.stop(audioContext.currentTime + fadeTime);
        lfo.stop(audioContext.currentTime + fadeTime);
        
        // Clean up after fade completes
        setTimeout(() => {
          delete activeNotes[noteId];
        }, fadeTime * 1000);
      });
      
      if (el) el.classList.remove('active');
    }

    function adjust(id, delta) {
      const el = document.getElementById(id);
      el.value = Math.max(el.min, Math.min(el.max, parseInt(el.value) + delta));
      el.dispatchEvent(new Event('input'));
    }

    function setWaveform(type) {
      waveform = type;
      
      // Update visual state
      document.querySelectorAll('.waveform-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-waveform="${type}"]`).classList.add('active');
    }

    function loadPreset(presetName) {
      const presets = {
        piano: {
          waveform: 'sine',
          volume: 30,
          attack: 5,
          release: 20,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        bass: {
          waveform: 'square',
          volume: 40,
          attack: 1,
          release: 50,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        lead: {
          waveform: 'sawtooth',
          volume: 25,
          attack: 2,
          release: 15,
          detune: 5,
          reverb: 'on',
          arpeggiator: 'off',
          lfoRate: 2,
          lfoDepth: 10,
          lfoTarget: 'pitch'
        },
        pad: {
          waveform: 'sine',
          volume: 20,
          attack: 100,
          release: 100,
          detune: 10,
          reverb: 'on',
          arpeggiator: 'off',
          lfoRate: 0.5,
          lfoDepth: 15,
          lfoTarget: 'volume'
        },
        pluck: {
          waveform: 'square',
          volume: 35,
          attack: 1,
          release: 5,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        bell: {
          waveform: 'triangle',
          volume: 30,
          attack: 1,
          release: 80,
          detune: 0,
          reverb: 'on',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        chord: {
          waveform: 'sine',
          volume: 25,
          attack: 10,
          release: 60,
          detune: 5,
          reverb: 'on',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        arp: {
          waveform: 'square',
          volume: 30,
          attack: 1,
          release: 10,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'up',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        
        // Scrypture Sound Presets
        'achievement-common': {
          waveform: 'sine',
          volume: 25,
          attack: 1,
          release: 15,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        'achievement-rare': {
          waveform: 'triangle',
          volume: 30,
          attack: 2,
          release: 25,
          detune: 5,
          reverb: 'on',
          arpeggiator: 'off',
          lfoRate: 1,
          lfoDepth: 8,
          lfoTarget: 'pitch'
        },
        'achievement-legendary': {
          waveform: 'sawtooth',
          volume: 35,
          attack: 5,
          release: 40,
          detune: 10,
          reverb: 'on',
          arpeggiator: 'up',
          lfoRate: 2,
          lfoDepth: 15,
          lfoTarget: 'pitch'
        },
        'task-complete': {
          waveform: 'sine',
          volume: 20,
          attack: 1,
          release: 8,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        'level-up': {
          waveform: 'square',
          volume: 30,
          attack: 3,
          release: 20,
          detune: 5,
          reverb: 'on',
          arpeggiator: 'up',
          lfoRate: 1.5,
          lfoDepth: 12,
          lfoTarget: 'pitch'
        },
        'bobr-greeting': {
          waveform: 'triangle',
          volume: 25,
          attack: 5,
          release: 30,
          detune: 3,
          reverb: 'on',
          arpeggiator: 'off',
          lfoRate: 0.8,
          lfoDepth: 6,
          lfoTarget: 'volume'
        },
        'dam-build': {
          waveform: 'square',
          volume: 28,
          attack: 2,
          release: 15,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        'streak-milestone': {
          waveform: 'sine',
          volume: 30,
          attack: 1,
          release: 12,
          detune: 2,
          reverb: 'on',
          arpeggiator: 'off',
          lfoRate: 0.5,
          lfoDepth: 4,
          lfoTarget: 'pitch'
        },
        'ui-click': {
          waveform: 'sine',
          volume: 15,
          attack: 1,
          release: 5,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        'form-submit': {
          waveform: 'triangle',
          volume: 20,
          attack: 2,
          release: 10,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        'modal-open': {
          waveform: 'sine',
          volume: 18,
          attack: 3,
          release: 8,
          detune: 0,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        },
        'xp-gain': {
          waveform: 'triangle',
          volume: 22,
          attack: 1,
          release: 6,
          detune: 1,
          reverb: 'off',
          arpeggiator: 'off',
          lfoRate: 0,
          lfoDepth: 0,
          lfoTarget: 'pitch'
        }
      };

      const preset = presets[presetName];
      if (!preset) return;

      // Apply preset values
      setWaveform(preset.waveform);
      
      // Update sliders and controls (excluding volume)
      // Volume is preserved - not changed by presets
      
      document.getElementById('attack').value = preset.attack;
      attack = preset.attack / 100;
      
      document.getElementById('release').value = preset.release;
      release = preset.release / 100;
      
      document.getElementById('detune').value = preset.detune;
      document.getElementById('detuneValue').textContent = preset.detune + '¢';
      detune = preset.detune;
      
      document.getElementById('reverb').value = preset.reverb;
      reverbEnabled = preset.reverb === 'on';
      
      document.getElementById('arpeggiator').value = preset.arpeggiator;
      
      document.getElementById('lfoRate').value = preset.lfoRate;
      document.getElementById('lfoRateValue').textContent = preset.lfoRate + ' Hz';
      lfoRate = preset.lfoRate;
      
      document.getElementById('lfoDepth').value = preset.lfoDepth;
      lfoDepth = preset.lfoDepth;
      
      document.getElementById('lfoTarget').value = preset.lfoTarget;
      lfoTarget = preset.lfoTarget;

      // Update detune for all currently playing notes
      Object.values(activeNotes).forEach(({ osc }) => {
        osc.detune.setValueAtTime(detune, audioContext.currentTime);
      });
    }

    function toggleSection(sectionId) {
      const section = document.querySelector(`[onclick="toggleSection('${sectionId}')"]`).parentElement;
      section.classList.toggle('collapsed');
    }

    function resetDetune() {
      detune = 0;
      document.getElementById('detune').value = 0;
      document.getElementById('detuneValue').textContent = '0¢';
      // Update detune for all currently playing notes
      Object.values(activeNotes).forEach(({ osc }) => {
        osc.detune.setValueAtTime(0, audioContext.currentTime);
      });
    }

    function toggleSustain() {
      sustainMode = !sustainMode;
      const sustainBtn = document.getElementById('sustainBtn');
      sustainBtn.classList.toggle('active');
      
      if (!sustainMode) {
        // Stop all sustained notes
        Object.values(activeNotes).forEach(note => {
          stopNote(note.freq);
        });
      }
    }
    document.getElementById('volume').oninput = e => {
      const value = e.target.value;
      masterGain.gain.value = value / 100;
      document.getElementById('volumeValue').textContent = value + '%';
    };
    document.getElementById('attack').oninput = e => attack = e.target.value / 100;
    document.getElementById('release').oninput = e => release = e.target.value / 100;
    document.getElementById('detune').oninput = e => {
      detune = parseInt(e.target.value);
      document.getElementById('detuneValue').textContent = detune + '¢';
      // Update detune for all currently playing notes in real-time
      Object.values(activeNotes).forEach(({ osc }) => {
        osc.detune.setValueAtTime(detune, audioContext.currentTime);
      });
    };
    document.getElementById('reverb').onchange = e => reverbEnabled = e.target.value === 'on';
    document.getElementById('lfoRate').oninput = e => {
      lfoRate = parseFloat(e.target.value);
      document.getElementById('lfoRateValue').textContent = lfoRate + ' Hz';
    };
    document.getElementById('lfoDepth').oninput = e => lfoDepth = parseInt(e.target.value);
    document.getElementById('lfoTarget').onchange = e => lfoTarget = e.target.value;

    let isDragging = false;
    let lastPlayedKey = null;

    document.querySelectorAll('.key').forEach(el => {
      const freq = parseFloat(el.dataset.freq);
      
      el.addEventListener('mousedown', () => {
        isDragging = true;
        lastPlayedKey = el;
        startNote(freq, el);
      });
      
      el.addEventListener('mouseup', () => {
        if (!sustainMode) stopNote(freq, el);
        isDragging = false;
        lastPlayedKey = null;
      });
      
      el.addEventListener('mouseenter', () => {
        if (isDragging && el !== lastPlayedKey) {
          lastPlayedKey = el;
          startNote(freq, el);
        }
      });
      
      el.addEventListener('mouseleave', () => {
        if (!sustainMode) stopNote(freq, el);
      });
      
      el.addEventListener('touchstart', e => {
        e.preventDefault();
        isDragging = true;
        lastPlayedKey = el;
        startNote(freq, el);
      }, { passive: false });
      
      el.addEventListener('touchend', () => {
        if (!sustainMode) stopNote(freq, el);
        isDragging = false;
        lastPlayedKey = null;
      });
      
      el.addEventListener('touchmove', e => {
        e.preventDefault();
        if (isDragging) {
          const touch = e.touches[0];
          const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
          if (elementBelow && elementBelow.classList.contains('key') && elementBelow !== lastPlayedKey) {
            lastPlayedKey = elementBelow;
            const touchFreq = parseFloat(elementBelow.dataset.freq);
            startNote(touchFreq, elementBelow);
          }
        }
      }, { passive: false });
    });

    // Stop dragging when mouse leaves the keyboard area
    document.getElementById('keyboard').addEventListener('mouseleave', () => {
      isDragging = false;
      lastPlayedKey = null;
    });

    document.addEventListener('keydown', e => {
      const note = notes.find(n => n.key === e.key);
      if (note && !pressed.has(note.freq)) {
        const el = document.querySelector(`.key[data-key="${note.key}"]`);
        startNote(note.freq, el);
        pressed.add(note.freq);
      }
      
      // Number keys for patterns (0-9)
      if (e.key >= '0' && e.key <= '9') {
        const number = parseInt(e.key);
        loadPattern(number);
        
        // Visual feedback
        document.querySelectorAll('.num-key').forEach(k => k.classList.remove('active'));
        const keyEl = document.querySelector(`.num-key[data-number="${number}"]`);
        if (keyEl) keyEl.classList.add('active');
      }
    });

    document.addEventListener('keyup', e => {
      const note = notes.find(n => n.key === e.key);
      if (note && !sustainMode) {
        const el = document.querySelector(`.key[data-key="${note.key}"]`);
        stopNote(note.freq, el);
        pressed.delete(note.freq);
      }
      
      // Spacebar to play/stop sequencer
      if (e.code === 'Space') {
        e.preventDefault();
        if (isPlaying) {
          stopSequence();
        } else {
          playSequence();
        }
      }
    });

    document.addEventListener('click', () => {
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }, { once: true });

    // Number key functionality
    document.querySelectorAll('.num-key').forEach(key => {
      key.addEventListener('click', () => {
        const number = parseInt(key.dataset.number);
        loadPattern(number);
        
        // Visual feedback
        document.querySelectorAll('.num-key').forEach(k => k.classList.remove('active'));
        key.classList.add('active');
      });
    });

    function loadPattern(number) {
      if (!numberKeyPatterns[number]) return;
      
      currentPattern = number;
      
      // Clear current pattern
      clearSequence();
      
      // Load the selected pattern
      const pattern = numberKeyPatterns[number];
      const noteNames = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
      
      pattern.forEach(step => {
        if (step < steps) {
          // Place notes on multiple tracks for variety
          const trackIndex = step % noteNames.length;
          const note = noteNames[trackIndex];
          sequence[note][step] = true;
        }
      });
      
      // Update visual display
      updateTimelineDisplay();
    }

    function updateTimelineDisplay() {
      document.querySelectorAll('.step').forEach(step => {
        const note = step.dataset.note;
        const stepIndex = parseInt(step.dataset.step);
        step.classList.toggle('active', sequence[note][stepIndex]);
      });
    }

    // Sequencer functions
    function createTimeline() {
      const stepIndicators = document.getElementById('stepIndicators');
      const timelineTracks = document.getElementById('timelineTracks');
      
      // Clear existing content
      stepIndicators.innerHTML = '';
      timelineTracks.innerHTML = '';
      
      // Create step indicators
      for (let i = 0; i < steps; i++) {
        const indicator = document.createElement('div');
        indicator.className = 'step-indicator';
        indicator.textContent = (i + 1) % 10;
        stepIndicators.appendChild(indicator);
      }
      
      // Create tracks
      const noteNames = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
      const noteFreqs = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88];
      
      noteNames.forEach((note, index) => {
        const track = document.createElement('div');
        track.className = 'track';
        
        const label = document.createElement('div');
        label.className = 'track-label';
        label.textContent = note;
        
        const trackSteps = document.createElement('div');
        trackSteps.className = 'track-steps';
        
        for (let i = 0; i < steps; i++) {
          const step = document.createElement('div');
          step.className = 'step';
          step.dataset.note = note;
          step.dataset.step = i;
          step.dataset.freq = noteFreqs[index];
          
          step.addEventListener('click', () => {
            if (drawMode) {
              sequence[note][i] = !sequence[note][i];
              step.classList.toggle('active');
            } else {
              sequence[note][i] = !sequence[note][i];
              step.classList.toggle('active');
            }
          });
          
          step.addEventListener('mouseenter', () => {
            if (drawMode && isDrawing) {
              // In draw mode, mouseenter always adds notes
              sequence[note][i] = true;
              step.classList.add('active');
            }
          });
          
          trackSteps.appendChild(step);
        }
        
        track.appendChild(label);
        track.appendChild(trackSteps);
        timelineTracks.appendChild(track);
      });
    }

    function playSequence() {
      if (isPlaying) return;
      
      isPlaying = true;
      currentStep = 0;
      document.getElementById('playBtn').textContent = 'Pause';
      
      const stepTime = (60 / bpm) * 4 / steps; // 16th note timing
      
      sequenceInterval = setInterval(() => {
        // Clear previous step indicator
        const indicators = document.querySelectorAll('.step-indicator');
        indicators.forEach(ind => ind.classList.remove('active'));
        
        // Highlight current step
        if (indicators[currentStep]) {
          indicators[currentStep].classList.add('active');
        }
        
        // Play notes for current step
        const noteNames = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const noteFreqs = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88];
        
        noteNames.forEach((note, index) => {
          if (sequence[note][currentStep]) {
            const freq = noteFreqs[index];
            if (!isNaN(freq) && freq > 0) {
              startNote(freq);
              
              // Stop note after a short duration with fade
              setTimeout(() => {
                stopNote(freq);
              }, stepTime * 1000 * 0.6);
            }
          }
        });
        
        currentStep = (currentStep + 1) % steps;
      }, stepTime * 1000);
    }

    function stopSequence() {
      if (!isPlaying) return;
      
      isPlaying = false;
      currentStep = 0;
      document.getElementById('playBtn').textContent = 'Play';
      
      if (sequenceInterval) {
        clearInterval(sequenceInterval);
        sequenceInterval = null;
      }
      
      // Clear step indicators
      document.querySelectorAll('.step-indicator').forEach(ind => {
        ind.classList.remove('active');
      });
      
      // Stop all playing notes
      Object.values(activeNotes).forEach(note => {
        stopNote(note.freq);
      });
    }

    function clearSequence() {
      // Clear sequence data
      Object.keys(sequence).forEach(note => {
        sequence[note].fill(false);
      });
      
      // Clear visual indicators
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
      });
    }

    function toggleDrawMode() {
      drawMode = !drawMode;
      const drawBtn = document.getElementById('drawBtn');
      drawBtn.textContent = drawMode ? 'Click' : 'Draw';
      drawBtn.style.backgroundColor = drawMode ? '#4a4a4a' : '#2d2d2d';
    }

    // Add mouse event handlers for draw mode
    document.addEventListener('mousedown', () => {
      if (drawMode) {
        isDrawing = true;
      }
    });

    document.addEventListener('mouseup', () => {
      if (drawMode) {
        isDrawing = false;
      }
      isDraggingCircle = false;
    });

    // Initialize timeline and circle of fifths
    createTimeline();
    createCircleOfFifths();
    
    // Add event listeners for sequencer controls
    document.getElementById('bpm').oninput = e => {
      bpm = parseInt(e.target.value);
      if (isPlaying) {
        stopSequence();
        playSequence();
      }
    };
    
    document.getElementById('steps').oninput = e => {
      steps = parseInt(e.target.value);
      createTimeline();
      if (isPlaying) {
        stopSequence();
        playSequence();
      }
    };
  </script>
</body>
</html>