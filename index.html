<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    
    <!-- Aggressive Cache Control Headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="Last-Modified" content="0" />
    
    <!-- Force fresh content -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="robots" content="noindex, nofollow" />
    
    <link rel="icon" type="image/png" href="/icon-192.png" />
    <link rel="apple-touch-icon" href="/icon-180.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="description" content="Scrypture - Your mystical habit-tracking companion with the Ancient BÃ³br. Build habits, track progress, and grow alongside your beaver companion." />
    <meta name="theme-color" content="#667eea" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Scrypture" />
    <link rel="manifest" href="/manifest.json" />
    <title>Scrypture - Mystical Habit Tracking</title>
    
    <!-- TypeScript Type Definitions and Data Structures -->
    <script>
      // Global type definitions matching src/types/index.ts
      window.ScryptureTypes = {
        // Task interface
        Task: {
          id: '',
          title: '',
          description: '',
          completed: false,
          createdAt: new Date(),
          updatedAt: new Date(),
          completedAt: null,
          priority: 'medium', // 'low' | 'medium' | 'high'
          categories: [], // string[]
          statRewards: {
            body: 0,
            mind: 0,
            soul: 0,
            xp: 0
          },
          difficulty: 0 // 0-9, Fibonacci scale
        },

        // Habit interface
        Habit: {
          id: '',
          name: '',
          description: '',
          streak: 0,
          bestStreak: 0,
          lastCompleted: null,
          createdAt: new Date(),
          targetFrequency: 'daily', // 'daily' | 'weekly' | 'monthly'
          categories: [], // string[]
          statRewards: {
            body: 0,
            mind: 0,
            soul: 0,
            xp: 0
          }
        },

        // User interface
        User: {
          id: '',
          name: '',
          level: 1,
          experience: 0,
          body: 0,
          mind: 0,
          soul: 0,
          achievements: [],
          createdAt: new Date(),
          updatedAt: new Date(),
          bobrStage: 'hatchling', // 'hatchling' | 'young' | 'mature'
          damProgress: 0 // 0-100 based on completed tasks
        },

        // Achievement interfaces
        AchievementCondition: {
          type: 'level_reach', // Various achievement types
          value: 0,
          category: '',
          timeframe: 'daily', // 'daily' | 'weekly' | 'monthly'
          stat: 'body', // 'body' | 'mind' | 'soul'
          difficulty: 0
        },

        Achievement: {
          id: '',
          name: '',
          description: '',
          category: 'progression', // 'progression' | 'mastery' | 'consistency' | 'exploration' | 'special'
          rarity: 'common', // 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary'
          conditions: [],
          rewards: {
            xp: 0,
            body: 0,
            mind: 0,
            soul: 0
          },
          icon: '',
          unlockedMessage: '',
          unlocked: false,
          unlockedAt: null,
          progress: 0 // 0-1 for partially completed achievements
        },

        AchievementProgress: {
          achievementId: '',
          progress: 0, // 0-1
          currentValue: 0,
          targetValue: 0,
          lastUpdated: new Date()
        },

        // BÃ³br interfaces
        BobrMessage: {
          id: '',
          type: 'greeting', // 'greeting' | 'task_completion' | 'level_up' | 'achievement' | 'motivation' | 'dam_progress'
          stage: 'hatchling', // 'hatchling' | 'young' | 'mature'
          context: {
            taskTitle: '',
            category: '',
            newLevel: 0,
            achievementName: '',
            damPercentage: 0
          },
          message: '',
          animation: 'idle' // 'idle' | 'celebrate' | 'build' | 'evolve'
        },

        BobrState: {
          stage: 'hatchling', // 'hatchling' | 'young' | 'mature'
          damProgress: 0,
          lastMessage: null,
          evolutionHistory: []
        }
      };

      // Global data storage for the application
      window.ScryptureData = {
        // Initialize with default data structures
        tasks: [],
        habits: [],
        user: null,
        achievements: [],
        achievementProgress: [],
        bobrState: {
          stage: 'hatchling',
          damProgress: 0,
          lastMessage: null,
          evolutionHistory: []
        },

        // Data validation functions
        validateTask: function(task) {
          return task && 
                 typeof task.id === 'string' &&
                 typeof task.title === 'string' &&
                 typeof task.completed === 'boolean';
        },

        validateHabit: function(habit) {
          return habit && 
                 typeof habit.id === 'string' &&
                 typeof habit.name === 'string' &&
                 typeof habit.streak === 'number';
        },

        validateUser: function(user) {
          return user && 
                 typeof user.id === 'string' &&
                 typeof user.name === 'string' &&
                 typeof user.level === 'number';
        },

        // Data persistence helpers
        saveToLocalStorage: function(key, data) {
          try {
            localStorage.setItem(`scrypture_${key}`, JSON.stringify(data));
            return true;
          } catch (error) {
            console.error('Failed to save to localStorage:', error);
            return false;
          }
        },

        loadFromLocalStorage: function(key) {
          try {
            const data = localStorage.getItem(`scrypture_${key}`);
            return data ? JSON.parse(data) : null;
          } catch (error) {
            console.error('Failed to load from localStorage:', error);
            return null;
          }
        },

        // Initialize data from localStorage
        initialize: function() {
          const savedTasks = this.loadFromLocalStorage('tasks');
          const savedHabits = this.loadFromLocalStorage('habits');
          const savedUser = this.loadFromLocalStorage('user');
          const savedAchievements = this.loadFromLocalStorage('achievements');
          const savedBobrState = this.loadFromLocalStorage('bobrState');

          if (savedTasks) this.tasks = savedTasks;
          if (savedHabits) this.habits = savedHabits;
          if (savedUser) this.user = savedUser;
          if (savedAchievements) this.achievements = savedAchievements;
          if (savedBobrState) this.bobrState = savedBobrState;

          console.log('Scrypture data initialized from localStorage');
        }
      };

      // Initialize data when the script loads
      window.ScryptureData.initialize();
      
      // Ensure the app is ready to load
      console.log('Scrypture global data initialized');
    </script>
  </head>
  <body>
    <div id="root">
      <!-- Enhanced fallback loading state for mobile -->
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #23211a;
        color: #e8e5d2;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Courier New', monospace;
        text-align: center;
        font-size: 14px;
        line-height: 1.4;
        padding: 2rem;
        box-sizing: border-box;
      ">
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 12px;
          padding: 16px;
          background: #2d2b22;
          border: 4px solid #b6a432;
          border-radius: 0px;
          box-shadow: 0 0 20px rgba(182, 164, 50, 0.6);
          animation: fadeIn 0.5s ease-out;
          max-width: 90vw;
        ">
          <div style="
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #b6a432;
            border: 2px solid #b6a432;
            border-radius: 0px;
            animation: beaverBounce 2s ease-in-out infinite;
          ">
            <img 
              src="/assets/Icons/beaver_32.png" 
              alt="BÃ³br" 
              style="
                width: 32px;
                height: 32px;
                filter: brightness(0) saturate(100%) invert(1);
              "
              onerror="this.style.display='none'; this.parentElement.innerHTML='ðŸ¦«';"
            />
          </div>
          
          <div style="font-size: 12px; text-align: center; margin-bottom: 8px;">
            Loading Scrypture...
          </div>
          
          <div style="font-size: 8px; color: rgba(232, 229, 210, 0.8); margin-bottom: 8px;">
            Initializing app...
          </div>
          
          <div style="
            width: 120px;
            height: 4px;
            background: #1a1812;
            border-radius: 0px;
            overflow: hidden;
            position: relative;
            margin-top: 8px;
          ">
            <div style="
              height: 100%;
              background: #b6a432;
              border-radius: 0px;
              animation: loadingProgress 2s ease-in-out infinite;
            "></div>
          </div>
          
          <div style="font-size: 6px; color: rgba(232, 229, 210, 0.5); margin-top: 8px;">
            <span id="loadingStatus">Checking device compatibility...</span>
          </div>
        </div>
        
        <style>
          @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
          }
          
          @keyframes beaverBounce {
            0%, 100% {
              transform: scale(1) rotate(0deg);
              box-shadow: 0 0 8px rgba(182, 164, 50, 0.5);
            }
            25% {
              transform: scale(1.1) rotate(-5deg);
              box-shadow: 0 0 16px rgba(182, 164, 50, 0.8);
            }
            50% {
              transform: scale(1.15) rotate(0deg);
              box-shadow: 0 0 20px rgba(182, 164, 50, 1);
            }
            75% {
              transform: scale(1.1) rotate(5deg);
              box-shadow: 0 0 16px rgba(182, 164, 50, 0.8);
            }
          }
          
          @keyframes loadingProgress {
            0% {
              width: 0%;
              opacity: 0.5;
            }
            50% {
              width: 70%;
              opacity: 1;
            }
            100% {
              width: 100%;
              opacity: 0.5;
            }
          }
        </style>
      </div>
    </div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Mobile debugging and status updates -->
    <script>
      // Mobile debugging and status updates
      const loadingStatus = document.getElementById('loadingStatus');
      let statusStep = 0;
      const statusMessages = [
        'Checking device compatibility...',
        'Initializing data structures...',
        'Loading React application...',
        'Setting up mobile optimizations...',
        'Almost ready...'
      ];
      
      function updateStatus() {
        if (loadingStatus && statusStep < statusMessages.length) {
          loadingStatus.textContent = statusMessages[statusStep];
          statusStep++;
        }
      }
      
      // Update status every 2 seconds
      const statusInterval = setInterval(updateStatus, 2000);
      
      // Mobile-specific checks
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      
      console.log('Mobile Debug - HTML Load:', {
        isMobile,
        isIOS,
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        },
        screen: {
          width: screen.width,
          height: screen.height
        },
        devicePixelRatio: window.devicePixelRatio,
        userAgent: navigator.userAgent
      });
      
      // Mobile-specific viewport fixes
      if (isMobile) {
        // Fix for iOS Safari viewport issues
        if (isIOS) {
          const viewport = document.querySelector('meta[name="viewport"]');
          if (viewport) {
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
          }
        }
        
        // Ensure proper viewport height on mobile
        const setViewportHeight = () => {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        };
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
      }
      
      // If the app doesn't load within 10 seconds, show an error
      setTimeout(() => {
        const root = document.getElementById('root');
        if (root && root.children.length === 1 && root.children[0].textContent.includes('Loading Scrypture')) {
          clearInterval(statusInterval);
          root.innerHTML = `
            <div style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background: #23211a;
              color: #e8e5d2;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              font-family: 'Courier New', monospace;
              text-align: center;
              font-size: 14px;
              line-height: 1.4;
              padding: 2rem;
              box-sizing: border-box;
            ">
              <div style="
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: #2d2b22;
                border: 4px solid #7b3b3b;
                border-radius: 0px;
                box-shadow: 0 0 20px rgba(123, 59, 59, 0.6);
                animation: fadeIn 0.5s ease-out;
                max-width: 90vw;
              ">
                <div style="
                  width: 64px;
                  height: 64px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background: #7b3b3b;
                  border: 2px solid #7b3b3b;
                  border-radius: 0px;
                  animation: errorPulse 2s ease-in-out infinite;
                ">
                  <div style="font-size: 24px;">ðŸš¨</div>
                </div>
                
                <div style="font-size: 12px; text-align: center; margin-bottom: 8px;">
                  Loading Timeout
                </div>
                
                <div style="font-size: 8px; color: rgba(232, 229, 210, 0.8); margin-bottom: 12px;">
                  The app is taking longer than expected to load.
                </div>
                
                <div style="font-size: 6px; color: rgba(232, 229, 210, 0.6); margin-bottom: 12px;">
                  <p>Device: ${isMobile ? 'Mobile' : 'Desktop'}</p>
                  <p>Viewport: ${window.innerWidth} Ã— ${window.innerHeight}</p>
                  <p>Screen: ${screen.width} Ã— ${screen.height}</p>
                </div>
                
                <button 
                  onclick="window.location.reload()"
                  style="
                    padding: 8px 16px;
                    background: #b6a432;
                    color: #23211a;
                    border: none;
                    border-radius: 0px;
                    cursor: pointer;
                    font-family: 'Courier New', monospace;
                    font-size: 8px;
                    transition: all 0.2s ease;
                  "
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'"
                >
                  Reload App
                </button>
                
                <button 
                  onclick="window.location.href='/mobile-debug.html'"
                  style="
                    padding: 8px 16px;
                    background: #3b4a6b;
                    color: #e8e5d2;
                    border: none;
                    border-radius: 0px;
                    cursor: pointer;
                    font-family: 'Courier New', monospace;
                    font-size: 8px;
                    transition: all 0.2s ease;
                    margin-top: 8px;
                  "
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'"
                >
                  Debug Mobile
                </button>
              </div>
              
              <style>
                @keyframes fadeIn {
                  from { opacity: 0; transform: scale(0.9); }
                  to { opacity: 1; transform: scale(1); }
                }
                
                @keyframes errorPulse {
                  0%, 100% {
                    transform: scale(1);
                    box-shadow: 0 0 8px rgba(123, 59, 59, 0.5);
                  }
                  50% {
                    transform: scale(1.1);
                    box-shadow: 0 0 16px rgba(123, 59, 59, 0.8);
                  }
                }
              </style>
            </div>
          `;
        }
      }, 10000);
      
      // Clear status interval when app loads successfully
      window.addEventListener('load', () => {
        setTimeout(() => {
          clearInterval(statusInterval);
        }, 5000);
      });
    </script>
  </body>
</html> 